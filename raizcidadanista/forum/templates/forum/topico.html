{% extends 'forum/base.html' %}
{% load bootstrap static forum_tags %}

{% block title %}Tópicos: {{ object.grupo }} - {{ object }} - Teia Digital - {% endblock %}
{% block ogtitle %}Tópicos: {{ object.grupo }} - {{ object }} - Teia Digital - {% endblock %}

{% block description %}Tópicos: {{ object.grupo }} - {{ object }} - Teia Digital - {% endblock %}
{% block ogdescription %}Tópicos: {{ object.grupo }} - {{ object }} - Teia Digital - {% endblock %}

{% block main %}
<div class="content-main contact-content margin-b-30">
    <div class="contact-content-upper">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="gallery_title">
                    <h3>
                        <a href="{{ object.grupo.get_absolute_url }}">{{ object.grupo }}</a>
                        {% if object.criador == user %}
                            {% if object.editavel %}
                            <a href="?encerrar=true"><button type="submit" class="btn btn-success button-topic">Encerrar Tópico</button></a>
                            {% else %}
                            <a href="?reabrir=true"><button type="submit" class="btn btn-success button-topic">Reabrir Tópico</button></a>
                            {% endif %}
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="col-article">
                    {% for conversa in conversas %}
                    <div id="conversa-{{ conversa.pk }}" class="panel panel-default panel-conversa">
                        <div class="panel-body">
                            <blockquote>
                                {% if forloop.first %}<h2>{{ object }}</h2>{% endif %}
                                {{ conversa.texto|safe }}
                                <footer>Por: {{ conversa.autor.get_first_name }} - {{ conversa.dt_criacao|date:"d/m/Y H:i" }}</footer>

                                <small>
                                    {% if object.editavel %}
                                        {% for tipocurtida in conversa.curtidas %}
                                        <span class="like-box like-{{ tipocurtida.status }}" data-count="{{ tipocurtida.queryset.count }}">
                                            <a class="like-link" href="?conversa={{ conversa.pk }}&curtir={{ tipocurtida.status }}">{{ tipocurtida.display }}</a>
                                            (<span class="like-count">{{ tipocurtida.queryset.count }}</span>)
                                            <div class="like-people">{% for like in tipocurtida.queryset %}{{ like.colaborador.get_first_name }}<br>{% empty %}...{% endfor %}</div>
                                        </span>
                                        {% if not forloop.last %}|{% endif %}
                                        {% endfor %}
                                        | <a class="mention-link" href="javascript://">Menção</a>
                                        {% if object.editavel and request.user == conversa.autor %}
                                            | <a class="edit-link" href="javascript://">Editar</a>
                                        {% endif %}
                                        {% if not forloop.first %}
                                        | <a class="responder-link" href="javascript://">Responder</a>
                                        {% endif %}
                                    {% else %}
                                        {% for tipocurtida in conversa.curtidas %}
                                        <span class="like-box like-{{ tipocurtida.status }}" data-count="{{ tipocurtida.queryset.count }}">
                                            {{ tipocurtida.display }}
                                            (<span class="like-count">{{ tipocurtida.queryset.count }}</span>)
                                            <div class="like-people">{% for like in tipocurtida.queryset %}{{ like.colaborador.get_first_name }}<br>{% empty %}...{% endfor %}</div>
                                        </span>
                                        {% if not forloop.last %}|{% endif %}
                                        {% endfor %}
                                        | <a class="mention-link" href="javascript://">Menção</a>
                                    {% endif %}
                                    {% if object.editavel and not forloop.first and conversa|has_delete_conversa:request.user %}
                                        | <a class="remove-link" href="?conversa={{ conversa.pk }}&excluir=true">Excluir</a>
                                    {% endif %}
                                </small>

                                <form action="{% url forum_mencao %}" method="POST" role="form" class="mention-form">{% csrf_token %}
                                    <div class="panel panel-conversa">
                                        <div class="panel-body">
                                            <input type="hidden" name="conversa" value="{{ conversa.pk }}" />
                                            <textarea class="mention" placeholder="@Nome"></textarea>
                                            <button type="submit" class="btn btn-success">Enviar</button>
                                        </div>
                                    </div>
                                </form>

                                {% if object.editavel and request.user == conversa.autor %}
                                <form action="" method="POST" role="form" class="edit-form">{% csrf_token %}
                                    <div class="panel-body">
                                        <input type="hidden" class="form-control" name="conversa_pai" id="id_conversa_pai" value="{{ conversa.conversa_pai.pk }}" />
                                        <input type="hidden" class="form-control" name="conversa" id="id_conversa" value="{{ conversa.pk }}" />
                                        <textarea id="id_texto-edit-conversa-{{ conversa.pk }}" rows="10" cols="40" class="form-control" name="texto">{{ conversa.texto }}</textarea>
                                        <br>
                                        <button type="submit" class="btn btn-success">Editar</button>
                                    </div>
                                </form>
                                <script type="text/javascript">
                                    CKEDITOR.replace("id_texto-edit-conversa-{{ conversa.pk }}", {"filebrowserWindowWidth": 940, "toolbar_Basic": [["Source", "-", "Bold", "Italic"]], "forcePasteAsPlainText": true, "toolbar_Full": [["Styles", "Format", "Bold", "Italic", "Underline", "Strike", "SpellChecker", "Undo", "Redo"], ["Image", "Flash", "Table", "HorizontalRule"], ["TextColor", "BGColor"], ["Smiley", "SpecialChar"], ["Source"]], "filebrowserUploadUrl": "/ckeditor/upload/", "extraPlugins": "smiley", "height": 100, "width": "100%", "filebrowserBrowseUrl": "/ckeditor/browse/", "skin": "moono", "filebrowserWindowHeight": 725, "toolbar": [["Bold", "Italic", "Underline", "TextColor", "NumberedList", "BulletedList", "Link", "Smiley"]]});
                                </script>
                                {% endif %}

                                {% if object.editavel and not forloop.first %}
                                <form action="" method="POST" role="form" class="responder-form">{% csrf_token %}
                                    <div class="panel panel-conversa">
                                        <div class="panel-body">
                                            <input type="hidden" class="form-control" name="conversa_pai" id="id_conversa_pai" value="{{ conversa.pk }}" />
                                            <textarea id="id_texto-{{ conversa.pk }}" rows="10" cols="40" class="form-control" name="texto"></textarea>
                                            <br>
                                            <button type="submit" class="btn btn-success">Responder</button>
                                        </div>
                                    </div>
                                </form>
                                <script type="text/javascript">
                                    CKEDITOR.replace("id_texto-{{ conversa.pk }}", {"filebrowserWindowWidth": 940, "toolbar_Basic": [["Source", "-", "Bold", "Italic"]], "forcePasteAsPlainText": true, "toolbar_Full": [["Styles", "Format", "Bold", "Italic", "Underline", "Strike", "SpellChecker", "Undo", "Redo"], ["Image", "Flash", "Table", "HorizontalRule"], ["TextColor", "BGColor"], ["Smiley", "SpecialChar"], ["Source"]], "filebrowserUploadUrl": "/ckeditor/upload/", "extraPlugins": "smiley", "height": 100, "width": "100%", "filebrowserBrowseUrl": "/ckeditor/browse/", "skin": "moono", "filebrowserWindowHeight": 725, "toolbar": [["Bold", "Italic", "Underline", "TextColor", "NumberedList", "BulletedList", "Link", "Smiley"]]});
                                </script>
                                {% endif %}

                                {% for conversa_filho in conversa.conversa_set.all %}
                                <div id="conversa-{{ conversa_filho.pk }}" class="panel panel-default panel-conversa">
                                    <div class="panel-body">
                                        <blockquote>
                                            {{ conversa_filho.texto|safe }}
                                            <footer>Por: {{ conversa_filho.autor.get_first_name }} - {{ conversa_filho.dt_criacao|date:"d/m/Y H:i" }}</footer>
                                            <small>
                                            {% if object.editavel %}
                                                {% for tipocurtida in conversa_filho.curtidas %}
                                                <span class="like-box like-{{ tipocurtida.status }}" data-count="{{ tipocurtida.queryset.count }}">
                                                    <a class="like-link" href="?conversa={{ conversa_filho.pk }}&curtir={{ tipocurtida.status }}">{{ tipocurtida.display }}</a>
                                                    (<span class="like-count">{{ tipocurtida.queryset.count }}</span>)
                                                    <div class="like-people">{% for like in tipocurtida.queryset %}{{ like.colaborador.get_first_name }}<br>{% empty %}...{% endfor %}</div>
                                                </span>
                                                {% if not forloop.last %}|{% endif %}
                                                {% endfor %}
                                                | <a class="mention-link" href="javascript://">Menção</a>
                                                {% if request.user == conversa_filho.autor %}
                                                    | <a class="edit-link" href="javascript://">Editar</a>
                                                {% endif %}
                                                | <a class="responder-link" href="javascript://">Responder</a>
                                                {% if conversa_filho|has_delete_conversa:request.user %}
                                                    | <a class="remove-link" href="?conversa={{ conversa_filho.pk }}&excluir=true">Excluir</a>
                                                {% endif %}
                                            {% else %}
                                                {% for tipocurtida in conversa_filho.curtidas %}
                                                <span class="like-box like-{{ tipocurtida.status }}" data-count="{{ tipocurtida.queryset.count }}">
                                                    {{ tipocurtida.display }}
                                                    (<span class="like-count">{{ tipocurtida.queryset.count }}</span>)
                                                    <div class="like-people">{% for like in tipocurtida.queryset %}{{ like.colaborador.get_first_name }}<br>{% empty %}...{% endfor %}</div>
                                                </span>
                                                {% if not forloop.last %}|{% endif %}
                                                {% endfor %}
                                                | <a class="mention-link" href="javascript://">Menção</a>
                                            {% endif %}
                                            </small>

                                            <form action="{% url forum_mencao %}" method="POST" role="form" class="mention-form">{% csrf_token %}
                                                <div class="panel panel-conversa">
                                                    <div class="panel-body">
                                                        <input type="hidden" name="conversa" value="{{ conversa_filho.pk }}" />
                                                        <textarea class="mention" placeholder="@Nome"></textarea>
                                                        <button type="submit" class="btn btn-success">Enviar</button>
                                                    </div>
                                                </div>
                                            </form>

                                            {% if object.editavel %}
                                            <form action="" method="POST" role="form" class="responder-form">{% csrf_token %}
                                                <div class="panel panel-conversa">
                                                    <div class="panel-body">
                                                        <input type="hidden" class="form-control" name="conversa_pai" id="id_conversa_pai" value="{{ conversa.pk }}" />
                                                        <textarea id="id_texto-{{ conversa_filho.pk }}" rows="10" cols="40" class="form-control" name="texto"></textarea>
                                                        <br>
                                                        <button type="submit" class="btn btn-success">Responder</button>
                                                    </div>
                                                </div>
                                            </form>
                                            <script type="text/javascript">
                                                CKEDITOR.replace("id_texto-{{ conversa_filho.pk }}", {"filebrowserWindowWidth": 940, "toolbar_Basic": [["Source", "-", "Bold", "Italic"]], "forcePasteAsPlainText": true, "toolbar_Full": [["Styles", "Format", "Bold", "Italic", "Underline", "Strike", "SpellChecker", "Undo", "Redo"], ["Image", "Flash", "Table", "HorizontalRule"], ["TextColor", "BGColor"], ["Smiley", "SpecialChar"], ["Source"]], "filebrowserUploadUrl": "/ckeditor/upload/", "extraPlugins": "smiley", "height": 100, "width": "100%", "filebrowserBrowseUrl": "/ckeditor/browse/", "skin": "moono", "filebrowserWindowHeight": 725, "toolbar": [["Bold", "Italic", "Underline", "TextColor", "NumberedList", "BulletedList", "Link", "Smiley"]]});
                                            </script>
                                            {% endif %}

                                            {% if object.editavel and request.user == conversa_filho.autor %}
                                            <form action="" method="POST" role="form" class="edit-form">{% csrf_token %}
                                                    <div class="panel-body">
                                                        <input type="hidden" class="form-control" name="conversa_pai" id="id_conversa_pai" value="{{ conversa.pk }}" />
                                                        <input type="hidden" class="form-control" name="conversa" id="id_conversa" value="{{ conversa_filho.pk }}" />
                                                        <textarea id="id_texto-edit-conversa-{{ conversa_filho.pk }}" rows="10" cols="40" class="form-control" name="texto">{{ conversa_filho.texto }}</textarea>
                                                        <br>
                                                        <button type="submit" class="btn btn-success">Editar</button>
                                                    </div>
                                            </form>
                                            <script type="text/javascript">
                                                CKEDITOR.replace("id_texto-edit-conversa-{{ conversa_filho.pk }}", {"filebrowserWindowWidth": 940, "toolbar_Basic": [["Source", "-", "Bold", "Italic"]], "forcePasteAsPlainText": true, "toolbar_Full": [["Styles", "Format", "Bold", "Italic", "Underline", "Strike", "SpellChecker", "Undo", "Redo"], ["Image", "Flash", "Table", "HorizontalRule"], ["TextColor", "BGColor"], ["Smiley", "SpecialChar"], ["Source"]], "filebrowserUploadUrl": "/ckeditor/upload/", "extraPlugins": "smiley", "height": 100, "width": "100%", "filebrowserBrowseUrl": "/ckeditor/browse/", "skin": "moono", "filebrowserWindowHeight": 725, "toolbar": [["Bold", "Italic", "Underline", "TextColor", "NumberedList", "BulletedList", "Link", "Smiley"]]});
                                            </script>
                                            {% endif %}
                                        </blockquote>
                                    </div>
                                </div>
                                {% endfor %}

                            </blockquote>
                        </div>
                    </div>
                    {% endfor %}

                    <nav>
                        <ul class="pager">
                            {% if conversas.has_previous %}
                            <li class="previous"><a href="{{ conversas.previous_page_number }}"><span aria-hidden="true">&larr;</span> Anterior</a></li>
                            {% endif %}
                            {% if conversas.has_next %}
                            <li class="next"><a href="{{ conversas.next_page_number }}">Próximo <span aria-hidden="true">&rarr;</span></a></li>
                            {% endif %}
                        </ul>
                    </nav>

                    {% if object.editavel %}
                    <form action="" method="POST" role="form">{% csrf_token %}
                        <div class="panel panel-default panel-conversa">
                            <div class="panel-body">
                                <h3>Novo comentário</h3>
                                <div class="form-group{% if form.texto.errors %} has-error has-feedback{% endif %} group-{{ form.texto.name }}">
                                    {{ form.texto|btform }}
                                    {% if form.texto.errors %}
                                    <ul class="list-unstyled">
                                        {% for error in form.texto.errors %}
                                        <li class="text-error"><small>{{ error }}</small></li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
<link href="{% static 'site/css/jquery.mentionsInput.css' %}" rel='stylesheet' type='text/css'>
<style type="text/css">
    .cke_bottom { display: none !important }
    .cke_contents {min-height: 100px !important; width: 100% !important;}
    .responder-form, .edit-form, .mention-form { display: none }
    .button-topic {
        float: right;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block js %}
<script src="{% static 'site/js/lib/jquery.events.input.js' %}" type='text/javascript'></script>
<script src="{% static 'site/js/lib/jquery.elastic.js' %}" type='text/javascript'></script>
<script src='https://cdn.rawgit.com/jashkenas/underscore/1.8.3/underscore-min.js' type='text/javascript'></script>
<script type="text/javascript" src="{% static 'site/js/jquery.mentionsInput.js' %}"></script>
<script type="text/javascript">
    /* show/hide response ckeditor */
    $('.responder-link').click(function(event) {
        $(this).parent().parent().find('.responder-form:first').slideToggle();
    });
    /* show/hide edit ckeditor */
    $('.edit-link').click(function(event) {
        $(this).parent().parent().find('.edit-form:first').slideToggle();
    });

    /* show/hide menstion */
    $('.mention-link').click(function(event) {
        $(this).parent().parent().find('.mention-form:first').slideToggle();
    });

    /* like interation */
    $('.like-link').click(function(event) {
        var likelink = $(this);
        $.getJSON(likelink.attr('href'), function(data) {
            $.each(data, function(index, val) {
                $(likelink).parent().parent().find('.like-'+val.status+' .like-count').html(val.count);
                $(likelink).parent().parent().find('.like-'+val.status+'').attr('data-count', val.count);
                $(likelink).parent().parent().find('.like-'+val.status+' .like-people').html('');
                $.each(val.people, function(index2, val2) {
                    $(likelink).parent().parent().find('.like-'+val.status+' .like-people').append(val2+'<br>');
                });
            });
        });
        return false;
    });

    /* show like people */
    $('.like-box').hover(function() {
        if($(this).attr('data-count')*1 > 0){
            $(this).find('.like-people').attr('style', 'display: inline-table');
        }
    }, function() {
        $(this).find('.like-people').hide();
    });

    /* remove conversa confirm */
    $('.remove-link').click(function(event) {
        return confirm("Você deseja realmente remover o seu comentário?");
    });


    /* Menção */
    $('textarea.mention').mentionsInput({
        onDataRequest:function (mode, query, callback) {
            $.getJSON('{% url forum_mencao %}', function(responseData) {
                responseData = _.filter(responseData, function(item) { return item.name.toLowerCase().indexOf(query.toLowerCase()) > -1 });
                callback.call(this, responseData);
            });
        }
    });
</script>
{% endblock %}